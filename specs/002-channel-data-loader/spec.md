# Feature Specification: Channel Data Loader

**Feature Branch**: `002-channel-data-loader`
**Created**: 2026-02-06
**Status**: Draft
**Input**: Скрипт для загрузки постов, комментариев и авторов из Telegram канала в иерархической структуре. Принцип 1 Channel -> 1 file. Секреты Telegram из .env.

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Load Channel Data to File (Priority: P1)

Как исследователь, я хочу загрузить все посты и комментарии из Telegram канала
в один файл, чтобы иметь локальную копию данных для последующего анализа.

**Why this priority**: Это базовая функциональность — без возможности загрузить
данные канала никакой дальнейший анализ невозможен.

**Independent Test**: Можно протестировать, запустив скрипт с одним каналом и
проверив, что создался файл с корректной иерархической структурой данных.

**Acceptance Scenarios**:

1. **Given** валидные Telegram API credentials в `.env` и публичный канал,
   **When** пользователь запускает скрипт с указанием канала,
   **Then** создаётся файл с именем канала, содержащий посты, комментарии и авторов.

2. **Given** канал без комментариев,
   **When** пользователь запускает загрузку,
   **Then** файл содержит посты с пустыми списками комментариев.

3. **Given** отсутствующий или невалидный `.env` файл,
   **When** пользователь запускает скрипт,
   **Then** выводится понятное сообщение об ошибке конфигурации.

---

### User Story 2 - Preserve Data Hierarchy (Priority: P2)

Как аналитик, я хочу, чтобы данные сохранялись в иерархической структуре
(канал → посты → комментарии → авторы), чтобы легко навигировать и обрабатывать данные.

**Why this priority**: Структура данных критична для удобства использования,
но сначала нужна базовая загрузка.

**Independent Test**: Можно проверить структуру выходного файла на соответствие
ожидаемой иерархии.

**Acceptance Scenarios**:

1. **Given** загруженные данные канала,
   **When** пользователь открывает выходной файл,
   **Then** данные организованы иерархически: канал содержит посты, посты содержат комментарии.

2. **Given** комментарий от пользователя,
   **When** данные сохраняются,
   **Then** информация об авторе (username, display name) включена в комментарий.

---

### User Story 3 - Handle Large Channels (Priority: P3)

Как пользователь, я хочу загружать данные из больших каналов с тысячами постов,
чтобы анализировать активные сообщества.

**Why this priority**: Масштабируемость важна, но базовый функционал должен
работать сначала на небольших каналах.

**Independent Test**: Можно протестировать на канале с 500+ постами и проверить
полноту загрузки.

**Acceptance Scenarios**:

1. **Given** канал с 1000+ постами,
   **When** пользователь запускает загрузку,
   **Then** все посты успешно загружаются с прогресс-индикацией.

2. **Given** превышение лимита API запросов,
   **When** происходит rate limiting,
   **Then** скрипт автоматически делает паузу и продолжает загрузку.

---

### Edge Cases

- Что если канал приватный? Система MUST сообщить об ошибке доступа с понятным объяснением.
- Что если `.env` содержит неполные credentials? Система MUST валидировать наличие всех
  обязательных переменных перед началом работы.
- Что если выходной файл уже существует? Система MUST предупредить пользователя и
  запросить подтверждение на перезапись (или использовать флаг --force).
- Что если соединение прервалось во время загрузки? Система MUST сохранить уже
  загруженные данные с пометкой "partial" в метаданных файла и сообщить о точке прерывания.

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Система MUST читать Telegram API credentials (API_ID, API_HASH) из файла `.env`
- **FR-002**: Система MUST принимать идентификатор канала (URL или username) как входной параметр
- **FR-003**: Система MUST загружать все посты из указанного канала
- **FR-004**: Система MUST загружать все комментарии для каждого поста
- **FR-005**: Система MUST извлекать информацию об авторах комментариев (username, display name, user ID)
- **FR-006**: Система MUST сохранять данные в один файл на канал в директорию `.specify-for-tg-analysis/memory/channels/`
- **FR-007**: Система MUST организовывать данные в иерархическую структуру (channel → posts → comments → authors)
- **FR-008**: Система MUST отображать прогресс загрузки (количество загруженных постов/комментариев)
- **FR-009**: Система MUST обрабатывать rate limiting с автоматическим retry и exponential backoff
- **FR-010**: Система MUST выводить понятные сообщения об ошибках (auth failure, access denied, network error)
- **FR-011**: Система MUST поддерживать ограничение количества загружаемых постов (опциональный параметр --limit)
- **FR-012**: Система MUST сохранять сессию авторизации Telegram в `.specify-for-tg-analysis/tg/` для повторного использования
- **FR-013**: Система MUST при прерывании соединения сохранять частичные данные с пометкой "partial" в метаданных
- **FR-014**: Система MUST добавить `.specify-for-tg-analysis/tg/` в .gitignore (файл сессии содержит чувствительные данные)

### Key Entities

- **Channel**: Telegram канал. Атрибуты: ID, username, title. Содержит коллекцию постов.
- **Post**: Сообщение в канале. Атрибуты: ID, текст, дата публикации, количество просмотров.
  Содержит коллекцию комментариев.
- **Comment**: Комментарий к посту. Атрибуты: ID, текст, дата, автор.
- **Author**: Пользователь Telegram. Атрибуты: user ID, username (может отсутствовать),
  display name (first_name + last_name).

## Clarifications

### Session 2026-02-06

- Q: Куда сохранять выходные файлы? → A: `.specify-for-tg-analysis/memory/channels/`
- Q: Поведение при прерывании соединения? → A: Сохранять загруженные данные с пометкой "partial"
- Q: Хранение сессии авторизации? → A: Сессия Telegram должна временно сохраняться
- Q: Где хранить файл сессии? → A: `.specify-for-tg-analysis/tg/` (НЕ должен попадать в Git и контекст агента)

## Assumptions

- Пользователь имеет валидные Telegram API credentials (API_ID и API_HASH с my.telegram.org)
- Целевые каналы публичные или пользователь имеет к ним доступ
- Выходной формат файла — структурированный текст, пригодный для парсинга (JSON)
- Система работает в режиме read-only (только чтение данных, без модификации)
- Один запуск = один канал = один выходной файл
- Выходные файлы сохраняются в `.specify-for-tg-analysis/memory/channels/`

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Пользователь может загрузить данные канала с 100 постами менее чем за 5 минут
- **SC-002**: Выходной файл содержит 100% постов из указанного диапазона
- **SC-003**: Каждый комментарий в выходном файле содержит информацию об авторе
- **SC-004**: Иерархическая структура данных позволяет найти любой комментарий по пути channel→post→comment
- **SC-005**: При ошибке аутентификации пользователь получает сообщение с указанием проблемы и способа решения
- **SC-006**: Скрипт успешно завершает работу после rate limiting без потери данных
